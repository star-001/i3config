define(function(require,exports){require("rewrite/jquery_rewrite"),require("rewrite/backbone_rewrite"),require("dao/sync");var a=require("utils/analytics"),b=require("configs/settings"),c=require("offline/storage"),d=require("service/notify"),e=require("service/reminder"),f=require("crx/domain"),g=require("crx/user"),h=require("crx/context-menu"),i=require("data-sync/index"),j=require("service/prefs"),k=function(){o(!1,function(){i.once(),l.popOut()},function(){l.popOut()})},l={createPanel:function(){var a=localStorage.getItem("account_info"),d=c.getCacheItem("extension_last_project")||"",e=b.protocol+b.domain+"/"+d,f="?channel=chrome_extension_open_panel";e+=a?f:"signin/"+f;var g={url:e,top:140,left:1e3,width:385,height:689,type:"panel"};root.isFirefox||(g.focused=!0);var h=function(a){c.setCacheItem("tab_showin",a.tabs[0]&&a.tabs[0].id),c.setCacheItem("win_popout",a.id)};root.isFirefox?root.windows.create(g).then(h):root.windows.create(g,h)},updatePanel:function(a){var b=function(){root.runtime.lastError?(c.setCacheItem("win_popout",""),c.setCacheItem("tab_showin",""),console.log("update failed, panel not exists")):console.log("update sucess")};root.isFirefox?root.windows.update(a,{focused:!0}).then(b):root.windows.update(a,{focused:!0},b)},listenWindow:function(){root.windows.onRemoved.addListener(function(a){a==c.getCacheItem("win_popout")&&(c.setCacheItem("win_popout",""),c.setCacheItem("tab_showin",""))}),root.tabs.onUpdated.addListener(function(a,b){if(a==c.getCacheItem("tab_showin")&&b.url){var d=b.url.split("#")[1];d&&3===d.split("/").length&&0===d.search(/(p|q|f)\//)&&c.setCacheItem("extension_last_project","#"+d)}}),root.browserAction.onClicked.addListener(function(b){a.report("extension_background","open_panel"),o(!1,k,k)})},popOut:function(){var a=c.getCacheItem("win_popout");a?l.updatePanel(Number(a)):l.createPanel()}},m=function(a){j.fetch({success:function(){n(a)},error:function(){n(a)}})},n=function(b){a.restart(),h.updateMenu(),i.restart(),e.restart(),g.initUserStatus(b)},o=function(a,b,c){f.initInfoFromServer(function(c){c||a?m(b):b&&b()},function(){h.updateMenu(),e.stop(),i.stop(),c&&c()})},p=function(){root.notifications.onClosed.addListener(d.notificationClosed),root.notifications.onClicked.addListener(d.notificationClicked),root.notifications.onButtonClicked.addListener(d.notificationBtnClick),root.runtime.onMessage.addListener(function(a,c,d){var e={"user-status":function(){o(!1,function(){g.getUser(function(a){d(a)})},function(){d({domain:b.domain,logined:!1})})},"default-status":function(){f.decideFinalDomain(function(){d({domain:b.domain,logined:!1})})},refreshPrefs:function(){j.fetch()}};return e[a.action]?(e[a.action](),!0):void 0}),root.cookies.onChanged.addListener(function(a){f.cookieListener(a,o)}),o(!0),h.initMenus(),l.listenWindow()};p()});