define(function(require,exports){var a=require("configs/settings"),b=require("configs/dict"),c=require("utils/timeformat"),d=require("utils/log"),e=require("utils/task-util"),f=require("utils/index"),g=require("service/prefs");exports.Model=Backbone.Model.extend({defaults:{title:"",content:"",sortOrder:0,priority:0,projectId:a.user.inboxId,startDate:null,dueDate:null,timeZone:null,status:0,items:[],assignee:null,deleted:0,progress:0},validate:function(a,b){return a.id?void 0:"need error"},messages:function(){this.on("change",this.taskChanged),this.on("sync",this.afterSync),this.on("change:startDate",this.afterChangeStartDate),this.on("change:reminders",this.taskRemindersChange),this.on("delAssignee",this.delAssignee)},initialize:function(){this.initStartDate(),this.initAllDay(),this.initRepeatFlag(),this.changedTime=c.prefMoment().unix(),this.messages(),this.dumpInTemp(this)},initStartDate:function(){this.has("dueDate")&&!this.has("startDate")&&this.set({startDate:this.get("dueDate"),dueDate:null})},initAllDay:function(){this.get("dueStart")||this.get("startDate")||this.get("isAllDay")!==!1||this.set({isAllDay:!0})},initRepeatFlag:function(){var a=this.get("repeatFlag"),c=this.get("repeatFrom");a&&a.match(/TK_SKIP=HOLIDAY/)?(a=c==b.repeatFromType.defaultVal?a.replace(/TK_SKIP=HOLIDAY/,"TT_SKIP=HOLIDAY,WEEKEND"):a.replace(/TK_SKIP/,"TT_SKIP"),this.set({repeatFlag:a})):a&&a.match(/TK_SKIP=/)&&(a=a.replace(/TK_SKIP=/,""),this.set({repeatFlag:a})),a&&a.match(/;$/)&&(a=a.replace(/;$/,""),this.set({repeatFlag:a}))},getDueDate:function(){var a=this.get("dueDate"),b=this.get("startDate");return a&&c.prefMoment(a)<=c.prefMoment(b)?null:a},calDueDate:function(a,d){var e=this.getDueDate();if(e){var f=c.getDiffEnd(this.get("startDate"),a,e);return f?d?f:f.utc().format(b.format.atomTime):c.formatToUtc(a)}return c.formatToUtc(a)},taskRemindersChange:function(){this.set({reminder:null,remindTime:null})},resetModifyData:function(){this.set("modifiedItems",{deletedIds:[],modifiedIds:[]})},updateModifiedIds:function(a){var b=this.get("modifiedItems");null==b&&this.resetModifyData(),-1===_.indexOf(this.get("modifiedItems").modifiedIds,a)&&this.get("modifiedItems").modifiedIds.push(a)},taskChanged:function(){var a=c.prefMoment().utc().format(b.format.atomTime);this.set({modifiedTime:a},{silent:!0})},url:function(){return a.API_HOST+"/task"+(this.isNew()?"":"/"+this.id)},afterChangeStartDate:function(a){this.updateRemindTime(),this.formatToUtc(),this.willRepeat()},updateRemindTime:function(){this.set("remindTime",null)},formatToUtc:function(){var a=c.formatToUtc(this.get("startDate"));a&&this.set("startDate",a,{silent:!0})},setItemsNewId:function(a){a=a||[],a.map(function(a){a.id=ObjectId()})},resetSubtaskStatus:function(){var a=this.get("items")||[],b=this;a.map(function(a){if(a.status=0,a.startDate&&b.nextDueDate){a.snoozeReminderTime=null,a.completedTime=null;var d=c.prefMoment(b.nextDueDate).diff(b.get("startDate"),"days");a.startDate=c.formatToUtc(c.prefMoment(a.startDate).add(d,"days"))}})},cloneTask:function(a,b){var c=f.clone(this);return c=new exports.Model(c),c.set("id",ObjectId()),c.unset("etag"),c.unset("completedTime"),c.unset("commentCount"),b&&b(c),"object"==typeof a&&c.set(a),c.setItemsNewId(c.get("attachments")),c.setItemsNewId(c.get("reminders")),c.setItemsNewId(c.get("items")),c},_cloneAchiveTask:function(){var a=this.cloneTask({repeatFlag:null,status:2,completedTime:c.prefMoment().format(b.format.atomTime),repeatTaskId:this.get("id")});a.local=!0,Backbone.trigger("addToTaskdb",a),a.save({},{success:function(){a.local=!1}})},setNextDuedate:function(){try{var a=this.nextDueDate;if(this.get("repeatFrom")===b.repeatFromType.completedTime&&null!=this.nextDueDate){var c=new Date(this.get("startDate"));a=new Date(a),a.setHours(c.getHours()),a.setMinutes(c.getMinutes()),a.setSeconds(c.getSeconds()),a=a.toString()}var e=this.calDueDate(a);this.set({startDate:a,dueDate:e})}catch(f){d.log(f)}},afterSync:function(){this.local=null,this.set("local",!1),this.initAllDay(),this.initRepeatFlag(),this.requesting=!1,this.saveCallback&&this.save()},save:function(a,b){var c=(new Date).getTime(),e=this.lastSyncTime||0,f=c-e;if(this.saveCallback=!1,12e4>=f&&this.requesting)return this.saveCallback=!0,void d.log("frequent saving detected");this.lastSyncTime=c,this.requesting=!0,(!this.get("status")||a&&0===a.status)&&this.get("completedTime")&&this.unset("completedTime"),this.get("startDate")||this.set({reminders:null,isAllDay:null,remindTime:null,reminder:null});var g=this;b||(b={}),b.error=function(a){g.requesting=!1,d.log("task save error",a)},Backbone.Model.prototype.save.call(this,a,b)},toggleModelComplete:function(a){var d=this.get("status"),e=d?0:2;e>0?this.set({completedTime:c.prefMoment().format(b.format.atomTime)}):this.set({sortOrder:a?a:this.get("sortOrder"),completedTime:null});var f=this.isWillRepeat=this.willRepeat();f?(this.set("status",0),this._cloneAchiveTask(),this.resetSubtaskStatus(),this.setNextDuedate(),this.unset("completedTime"),this.set({progress:0})):this.set("status",e),this.save()},willRepeat:function(){var a=this.get("repeatFlag");if(null===a||_.isEmpty(a))return!1;var b=this.nextDueDate=e.getNextDueDate(this);return b?!0:!1},getCalTime:function(){var a=this.get("startDate");if(this.get("isAllDay")){var b=g.getDailyRemindTime(),c=moment(a).format("YYYY-MM-DDT")+b;a=moment.utc(c)}return a},_reducedErrorReminder:function(){var a=this.get("reminders"),b=this.get("startDate"),c=this.get("reminder"),d=!1;if(b){if(_.isEmpty(a)&&c){var e={id:ObjectId(),trigger:c};this.set("reminders",[e]),this.set("isAllDay",!1),d=!0}null===this.get("isAllDay")&&(this.set("isAllDay",!1),d=!0),d&&this.save()}},dumpInTemp:function(a){this.beforeChange=JSON.parse(JSON.stringify(a))}})});