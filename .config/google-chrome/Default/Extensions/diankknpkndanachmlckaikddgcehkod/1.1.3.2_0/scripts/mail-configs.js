!function(){function a(){var a=navigator.userAgent.toLowerCase(),b=(a.match(/safari/)&&null===a.match(/chrome/),null!==a.match(/chrome/)),c=null!==a.match(/firefox/),d=(null!==a.match(/trident/),null!==a.match(/msie 10.0/),null!==a.match(/edge/));b&&(u=chrome,u.isChrome=!0),c&&(u=browser,u.isFirefox=!0),d&&(u=browser,u.isEdge=!0)}function b(){var a=x.isCnSites?"/html/frame_dd.html":"/html/frame_tt.html";y.iframe=document.createElement("iframe"),$(y.iframe).ready(function(){h(),C||(C=setInterval(h,1e3))}),y.iframe.src=u.extension.getURL(a),y.iframe.id="tt-mail-iframe",document.body.appendChild(y.iframe),o(),d()}function c(){if(!y.$status){if(document.getElementById("tk-status"))return void(y.$status=$("#tk-status"));y.$status=$('<div id="tk-status"><div class="status"></div></div>'),$("body").append(y.$status),y.$status.css({visibility:"hidden",position:"fixed",top:"50px",width:"100%","text-align":"center","margin-top":"-20px","z-index":99999999}).find(".status").css({display:"inline-block","font-size":"14px","font-weight":"bold",border:"1px solid #f0c36d","background-color":"#f9edbe",padding:"0 10px","border-radius":"2px","box-shadow":"0 2px 4px rgba(0,0,0,0.2)"})}}function d(){$(window).on("message.tick_extension_mail",f)}function e(){$(window).off("message.tick_extension_mail")}function f(a){var b=a.originalEvent;"load completed"==b.data?(C&&(clearInterval(C),C=null),"INBOX"!==z&&g()):"add sucess"==b.data.status?(l(b.data),q()):"login first"==b.data?k():"adding task"==b.data?m():"close iframe mail"==b.data?q():"add failed"==b.data&&n()}function g(){var a=j();B.pageInfo=a,B.status="show iframe",i()}function h(){B.status="set origin",B.referer=location.href,B.channel="mail",i()}function i(){sendIframe=y.iframe.contentWindow,sendIframe&&sendIframe.postMessage(B,u.extension.getURL("/"))}function j(){var a=A.getPageInfo();return a.content.length>1e3&&(a.content=a.content.substring(0,1e3)+"..."),a}function k(){var a=w.login_before+"<a href='"+x.site+"' target='_blank' style='color: #222; text-decoration: underline;'>"+x.productName+"</a>"+w.add_task;y.$status.css("visibility","visible").find(".status").html(a),setTimeout(function(){y.$status.css("visibility","hidden")},1e4)}function l(a){var b=w.task_has_been_saved+x.productName+", <a href='"+x.site+"/#p/"+a.projectId+"/tasks/"+a.taskId+"' target='_blank' style='color: #222; text-decoration: underline;'>"+w.check_here+"</a>";y.$status.css("visibility","visible").find(".status").html(b),setTimeout(function(){y.$status.css("visibility","hidden")},3e3)}function m(){y.$status.css("visibility","visible").find(".status").text(""+w.adding_task_to+x.productName+"...")}function n(){y.$status.css("visibility","visible").find(".status").text(w.add_failed)}function o(){var a={"z-index":0x27797f26d671c8,height:"420px",width:"315px",border:0,display:"none",position:"fixed",top:0};A.setIframePosition(a),$("#tt-mail-iframe").css(a)}function p(){e(),$("#tt-mail-iframe").remove()}function q(){$("#tt-mail-iframe").hide()}function r(){A.beforeShow&&A.beforeShow(),$("#tt-mail-iframe").show()}function s(){$("#tt-mail-iframe").is(":visible")?q():u.runtime.sendMessage(u.runtime.id,{action:"user-status"},function(a){domain=a.domain,a&&a.logined?x.domain===domain?y.iframe?(r(),g()):(p(),b(),r()):(G(a),p(),b(),r()):k()})}function t(){"GMAIL"===z&&(A=function(){var a=null,b=function(){c(),"onhashchange"in window&&$(window).on("hashchange",function(){c()})},c=function(){var b=$(".iH > div");if(b.length)if(0==$("#tk-button").length){var e=d();b.append(e),$("#tk-button").click(function(a){a.stopPropagation(),s()}),$("body").click(function(){q()})}else clearTimeout(a),a=null;else a=setTimeout(c,500)},d=function(){var a=$("<div id='gmail-extension' class='G-Ni J-J5-Ji'><div id='tk-button' class='T-I J-J5-Ji ar7 nf T-I-ax7 L3' data-tooltip='Add this thread' role='button'><div class='inner'><span class='Ykrj7b'>"+w.add_to_ticktick+x.productName+"</span><div class='G-asx T-I-J3 J-J5-Ji'>&nbsp;</div></div></div></div>");return a},e=function(){var a=$(".hP:visible").text(),b=document.location.href,c=$(".ii").eq(0).text().trim().replace(/(\n\s*){4,}/g,"\n\n\n\n");return{title:a,url:b,content:c}},f=function(a){a.top=$("#gmail-extension").offset().top+$("#gmail-extension").height(),a.left=$("#gmail-extension").offset().left};return{initialize:b,getPageInfo:e,setIframePosition:f}}()),"INBOX"===z&&(A=function(){function a(){var b=$(".gj.s2 [aria-expanded=true] .hOfgWc.s2");return b.length?void b.each(function(a,b){var d=$(b),e=d.find(".tk-button");if(!e.length){var f=u.runtime.getURL("/img/inbox_icon.png"),g=$('<li class="tk-button jA action actionIcon"><img style="width: 24px;height: 24px;" src="'+f+'" alt="" /></li>');d.prepend(g),g.on("click.opentickiframe",function(a){c=$(this).parents(".ap.s2"),s(),a.stopPropagation()})}}):void setTimeout(a,100)}var c=null,d=function(){e()},e=function(){var a=$(".scroll-list-item");f(a),$("body").on("DOMNodeInserted",function(a){$(a.target).hasClass("scroll-list-item")&&f($(a.target))}),p(),b()},f=function(b){b.on("click",function(b){var c=$(".gj.s2 [aria-expanded] .tk-button");c.off("click.opentickiframe"),c.remove(),a()})},g=function(){var a=c.parents(".scroll-list-item").find(".eo.xJNT8d").text(),b=c.find(".pA.s2").eq(0).text().trim().replace(/(\n\s*){4,}/g,"\n\n\n\n");return{title:a,url:"",content:b}},h=function(a){a.position="absolute"},i=function(){var a=c.find(".tk-button"),b=a.offset().left-$("#tt-mail-iframe").width();$("#tt-mail-iframe").css({top:a.offset().top,left:b})};return{initialize:d,getPageInfo:g,beforeShow:i,setIframePosition:h}}()),"OUTLOOK"===z&&(A=function(){function a(a){var b=a.find("._rp_k1 ._rp_l1 > div:first-child");if(!b.find(".tk-button").length){var c=u.runtime.getURL("/img/icon.png"),d=$('<div class="tk-button _rp_u1"><img style="width: 16px;height: 16px;padding: 7px;" src="'+c+'" alt="" /></div>');b.prepend(d),d.click(function(a){s(),a.stopPropagation()})}}var c=null,d=function(){e()},e=function(){var d=$("#primaryContainer ._n_T >._n_X >._n_X >div >._n_X");d.length?(clearTimeout(c),c=null,d.on("DOMNodeInserted",function(b){if($(b.target).hasClass("conductorContent")){var c=$(b.target);c.click(function(b){var d=c.find(".tk-button");$(".tk-button").hide(),d.length?d.show():a(c)}),setTimeout(function(){a(c)},2e3)}}),$("body").click(function(){q()}),p(),b()):c=setTimeout(function(){e()},500)},f=function(){var a=($(".tk-button:visible").parents("._rp_b5"),$(".conductorContent .rpHighlightAllClass.rpHighlightSubjectClass").text()),b="",c=document.location.href,d=document.getElementById("Item.MessageNormalizedBody");return d&&(b=d.innerText.trim().replace(/(\n\s*){4,}/g,"\n\n\n\n")),{title:a,url:c,content:b}},g=function(a){a.right=0,a.position="absolute"};return{initialize:d,getPageInfo:f,setIframePosition:g}}()),A.initialize()}var u=null;if(a(),u){var v={en:{login_before:"Please signin ",add_task:" before adding tasks",add_to_ticktick:"Add To ",task_has_been_saved:"Task has been saved in ",check_here:"check here",adding_task_to:"Adding task to ",add_failed:"Add Failed"},zh:{login_before:"请先登录 ",add_task:" 然后添加任务",add_to_ticktick:"添加至",task_has_been_saved:"任务已经被添加到",check_here:"点击查看",adding_task_to:"添加任务至",add_failed:"添加失败"}},w=v.en,x={},y={},z="",A={},B=null,C=null,D=location.href.match(/^http[s]?:\/\/(mail.google|inbox.google|outlook.live).com/);if(D&&D[1]){var E={"mail.google":"GMAIL","inbox.google":"INBOX","outlook.live":"OUTLOOK"};z=E[D[1]]}var F=function(a){var b="https://",c=a.match(/ticktick/)?!1:!0,d=navigator.language.replace("_","-").toLowerCase(),e=/zh\Scn/i.test(d);x={domain:a,isCnSites:c,productName:c?"滴答清单":"TickTick",site:b+a},w=e?v.zh:v.en},G=function(a){F(a.domain)};u.runtime.sendMessage(u.runtime.id,{action:"user-status"},function(a){B=a,G(a),t(),c()})}}();