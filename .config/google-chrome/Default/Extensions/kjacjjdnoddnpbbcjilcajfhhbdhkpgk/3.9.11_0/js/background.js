"use strict";var TIME_PER_TREE=10;var treeNum=1;var TOTAL_STAGES=3;var lastTreeTime=1500;var lastTreeTagId=0;var remainingTime=lastTreeTime;var lastSysTime,targetSysTime;var hasCheated;var topDesRandInd=0;var blacklist;var whitelist;var timer;var isWhitelistMode=false;var isLoggedIn=false;var isUploading=false;var DefaultTAG=[{tag_id:0,title:chrome.i18n.getMessage("plant_tag_0")},{tag_id:1,title:chrome.i18n.getMessage("plant_tag_1")},{tag_id:2,title:chrome.i18n.getMessage("plant_tag_2")},{tag_id:3,title:chrome.i18n.getMessage("plant_tag_3")},{tag_id:4,title:chrome.i18n.getMessage("plant_tag_4")},{tag_id:5,title:chrome.i18n.getMessage("plant_tag_5")},{tag_id:6,title:chrome.i18n.getMessage("plant_tag_6")},{tag_id:7,title:chrome.i18n.getMessage("plant_tag_7")}];var TREE_STATUS={READY:"ready",GROWING:"growing",GROWN:"grown",FAILED:"failed"};var isFinishMessageDismissed=true;var doNotShowFinishMessageForGuest;var purchasedProducts=[];var TREE_TYPE=[{id:0,name:"Cedar",prefix:"tree_default",type:"TREE",product_id:-1},{id:1,name:"Flower Tree",prefix:"flower_tree",type:"TREE",product_id:1},{id:2,name:"Tree House",prefix:"tree_house",type:"TREE",product_id:2},{id:3,name:"Nest",prefix:"bird_tree",type:"TREE",product_id:3},{id:4,name:"Lemon Tree",prefix:"lemon_tree",type:"TREE",product_id:6},{id:5,name:"Triplets",prefix:"castle_tree",type:"TREE",product_id:7},{id:6,name:"Bush",prefix:"flower_bush",type:"BUSH",product_id:-1},{id:7,name:"Octopus",prefix:"octopus",type:"TREE",product_id:10},{id:8,name:"Cherry Blossom",prefix:"cherry_blossom",type:"TREE",product_id:11},{id:9,name:"Coconut Tree",prefix:"coconut_tree",type:"TREE",product_id:12},{id:10,name:"Cat Tree",prefix:"cat_tree",type:"TREE",product_id:13},{id:11,name:"Grass",prefix:"grass",type:"BUSH",product_id:14},{id:12,name:"Pine Tree",prefix:"pine_tree",type:"TREE",product_id:15},{id:13,name:"Cactus Ball",prefix:"cactus_ball",type:"BUSH",special_childhood:[1,2],product_id:16},{id:14,name:"Pumpkin",prefix:"pumpkin",type:"BUSH",special_childhood:[1,2],product_id:22},{id:15,name:"Scarecrow",prefix:"scarecrow",type:"TREE",special_childhood:[1,2],product_id:23},{id:18,name:"Mushroom",prefix:"mushroom",type:"BUSH",special_childhood:[1,2],product_id:24},{id:19,name:"Big Cactus",prefix:"big_cactus",type:"TREE",special_childhood:[1,2],product_id:25},{id:20,name:"Ginkgo Tree",prefix:"ginkgo",type:"TREE",product_id:27},{id:21,name:"Wisteria Tree",prefix:"wisteria_tree",type:"TREE",product_id:28},{id:22,name:"Watermelon",prefix:"watermelon",type:"BUSH",special_childhood:[2],product_id:29},{id:23,name:"Bamboo",prefix:"bamboo",type:"TREE",special_childhood:[1,2],product_id:30},{id:24,name:"Candy Tree",prefix:"candy_tree",type:"TREE",special_childhood:[1,2],product_id:31},{id:25,name:"SunFlower",prefix:"sunflower",type:"BUSH",special_childhood:[1,2],product_id:32},{id:26,name:"Rose",prefix:"rose",type:"BUSH",special_childhood:[1,2],product_id:33},{id:27,name:"Maple",prefix:"maple",type:"TREE",product_id:34},{id:28,name:"BaobabTree",prefix:"baobab_tree",type:"TREE",special_childhood:[1,2],product_id:35},{id:29,name:"Raffelesia",prefix:"rafflesia",type:"BUSH",special_childhood:[1,2],product_id:36},{id:30,name:"Banana Tree",prefix:"banana_tree",type:"TREE",special_childhood:[1,2],product_id:37},{id:31,name:"New Year Bamboo",prefix:"new_year_bamboo",type:"TREE",special_childhood:[1,2],product_id:38},{id:32,name:"Earth Tree",prefix:"earth_tree",type:"BUSH",special_childhood:[1,2],product_id:39},{id:33,name:"Carnation",prefix:"Carnation",type:"BUSH",special_childhood:[1,2],product_id:40},{id:34,name:"Apple Tree",prefix:"apple_tree",type:"TREE",special_childhood:[1,2],product_id:41},{id:35,name:"Star Tree",prefix:"star_tree",type:"TREE",special_childhood:[1,2],product_id:42},{id:36,name:"Time Tree",prefix:"time_tree",type:"TREE",special_childhood:[1,2],product_id:43},{id:37,name:"Moon Tree",prefix:"moon_tree",type:"TREE",special_childhood:[1,2],product_id:44},{id:38,name:"Rainbow Flower",prefix:"rainbow_flower",type:"BUSH",special_childhood:[1,2],product_id:45},{id:39,name:"Ghost Mushroom",prefix:"ghost_mushroom",type:"BUSH",special_childhood:[1,2],product_id:46},{id:40,name:"Blue Mail Tree",prefix:"mail_tree_blue",type:"TREE",special_childhood:[1,2],product_id:47},{id:41,name:"Green Mail Tree",prefix:"mail_tree_green",type:"TREE",special_childhood:[1,2],product_id:48},{id:42,name:"Pink Mail Tree",prefix:"mail_tree_pink",type:"TREE",special_childhood:[1,2],product_id:49},{id:43,name:"Yellow Mail Tree",prefix:"mail_tree_yellow",type:"TREE",special_childhood:[1,2],product_id:50},{id:44,name:"Purple Mail Tree",prefix:"mail_tree_purple",type:"TREE",special_childhood:[1,2],product_id:51},{id:45,name:"Cattail Willow",prefix:"cattail_willow",type:"BUSH",special_childhood:[1,2],product_id:52},{id:46,name:"Clear Note Flower",prefix:"clear_note_flower",type:"BUSH",special_childhood:[1,2],product_id:53},{id:47,name:"Coral",prefix:"coral",type:"BUSH",special_childhood:[1,2],product_id:54},{id:56,name:"Cake Tree",prefix:"cake_tree",type:"TREE",special_childhood:[1,2],product_id:55},{id:57,name:"Dog Tree",prefix:"dog_tree",type:"TREE",special_childhood:[1,2],product_id:56},{id:-1,name:"dummy",prefix:"dummy",product_id:-1}];var HIDDEN_TREE_TYPES=[31,32,40,41,42,43,44,46,47,56];var currentState=TREE_STATUS.READY;var treeType=0;var currTreeUrl=null;var hasClass=function(el,cls){if(el.nodeName=="#text"){return false}return el.className.match(new RegExp("(\\s|^)"+cls+"(\\s|$)"))?true:false};var addClass=function(el,cls){if(!hasClass(el,cls)){el.className+=" "+cls}};var removeClass=function(el,cls){if(hasClass(el,cls)){var reg=new RegExp("(\\s|^)"+cls+"(\\s|$)");el.className=el.className.replace(reg," ")}};function getDefaultWhitelist(){return["wikipedia.org"]}function getDefaultBlacklist(){return["facebook.com","reddit.com","youtube.com"]}function executeToFrontPage(callback,arg){try{var popups=chrome.extension.getViews({type:"popup"});if(0<popups.length){callback(popups[0],arg)}}catch(e){}}function saveLastTreeTagId(tag_id){lastTreeTagId=tag_id;chrome.storage.local.set({lastTreeTagId:tag_id},function(){})}function savePlanting(){chrome.storage.local.get({user:null},function(items){var user=items.user;var start_time=(new Date).toISOString();var token=null;if(user!==null){token=user.remember_token}var trees=[];for(var i=0;i<getStageToTreeNumber(getStage(lastTreeTime));++i){trees.push({tree_type:treeType,is_dead:true,position:0,phase:8})}chrome.storage.local.set({planting:{plant:{start_time:start_time,end_time:start_time,is_success:false,tag:lastTreeTagId,note:chrome.i18n.getMessage("main_planting_note_chrome"),trees:trees},authenticate_token:token}},function(){})})}function updateFromServer(type,callback){chrome.storage.local.get({grownTree:null,user:null,lastUpdateTime:"2017-08-15T03:14:56.840Z"},function(items){if(items.grownTree!=null&&items.grownTree.length!=0){var p=items.grownTree;var grownTree=new Array;var user=items.user;var lastUpdateTime=items.lastUpdateTime;var tempTime=new Date(lastUpdateTime);lastUpdateTime=new Date(tempTime.getTime()-1e6);var updatedTree;if(p!=null&&user!=null){var xhr=new XMLHttpRequest;var url="https://c88fef96.forestapp.cc/api/v1/plants/updated_plants?update_since="+lastUpdateTime.toISOString()+"&authenticate_token="+user.remember_token;xhr.open("GET",url,true);xhr.setRequestHeader("Content-type","application/json; charset=utf-8");xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status==200){updatedTree=JSON.parse(xhr.responseText);updatedTree=updatedTree.plants;popout()}else{callback()}}else{callback()}};xhr.send()}}else{callback()}function popout(){var plant=p.shift();if(typeof plant==="undefined"){chrome.storage.local.set({grownTree:grownTree},function(){chrome.storage.local.remove("lastUpdateTime",function(){});callback()})}else{update(plant,function(){popout()})}}function update(plant,callback){if(type=="update"){if(typeof plant.plant.id!=="undefined"&&plant.plant.id!=null){var newP=updatedTree.find(function(updatedP){return updatedP.id==plant.plant.id});plant.plant.tag=newP.tag;plant.plant.note=newP.note;grownTree.push(plant);callback()}else{grownTree.push(plant);callback()}}else if(type=="login"){if(typeof plant.plant.user_id==="undefined"||plant.plant.user_id==user.user_id||plant.plant.user_id==null){grownTree.push(plant);callback()}else{callback()}}else{callback()}}})}function uploadTree(type,callback){chrome.storage.local.get({planting:null,grownTree:null,user:null,uploadCache:null,IDtemp:1,lastUpdateTime:null},function(items){var p=new Array;var grownTree=new Array;var planting=items.planting;var token=null;var uploadCache=items.uploadCache;var IDtemp=parseInt(items.IDtemp);var lastUpdateTime=items.lastUpdateTime;if(items.user!=null){token=items.user.remember_token}switch(type){case"grown":if(!isUploading){upload(planting,function(){if(items.grownTree!=null){grownTree=grownTree.concat(items.grownTree)}chrome.storage.local.set({grownTree:grownTree,IDtemp:IDtemp},function(){updateFromServer("update",function(){callback()});chrome.storage.local.remove("planting",function(){})})})}else{chrome.storage.local.set({uploadCache:planting},function(){chrome.storage.local.remove("planting",function(){})})}break;case"sync":isUploading=true;if(items.grownTree!=null){p=items.grownTree}popout();break;case"cache":if(uploadCache!=null){upload(uploadCache,function(){if(items.grownTree!=null){grownTree=grownTree.concat(items.grownTree)}chrome.storage.local.set({grownTree:grownTree,IDtemp:IDtemp},function(){chrome.storage.local.remove("uploadCache",function(){});callback()})})}else{callback()}break;default:break}function popout(){var plant=p.shift();if(typeof plant==="undefined"){chrome.storage.local.set({grownTree:grownTree,IDtemp:IDtemp,lastUpdateTime:lastUpdateTime},function(){isUploading=false;uploadTree("cache",function(){updateFromServer("update",function(){callback()})})})}else{upload(plant,function(){popout()})}}function upload(plant,callback){if(plant!==null){if(plant.syncState=="Success"){var update_time=plant.plant.updated_at;if(lastUpdateTime==null){lastUpdateTime=update_time}else{var lstTime=new Date(lastUpdateTime);var uptTime=new Date(update_time);if(lstTime>uptTime){lastUpdateTime=update_time}}grownTree.push(plant);callback()}else{var xhr=new XMLHttpRequest;if(typeof plant.plant.id==="undefined"||plant.plant.id==null){xhr.open("POST","https://c88fef96.forestapp.cc/api/v1/plants",true)}else if(plant.syncState=="WaitForSync"||plant.syncState=="EditFail"){var url="https://c88fef96.forestapp.cc/api/v1/plants/"+plant.plant.id;xhr.open("PUT",url,true)}else{xhr.open("POST","https://c88fef96.forestapp.cc/api/v1/plants",true)}var uploadPlanting=JSON.parse(JSON.stringify(plant));uploadPlanting.authenticate_token=token;for(var i in uploadPlanting.plant.trees){uploadPlanting.plant.trees[i].tree_type=TREE_TYPE[plant.plant.trees[i].tree_type].id}if(typeof uploadPlanting.syncState!=="undefined"||typeof uploadPlanting.failedStatus!=="undefined"){delete uploadPlanting.browserTreeID;delete uploadPlanting.syncState;delete uploadPlanting.failedStatus}var string=JSON.stringify(uploadPlanting);xhr.setRequestHeader("Content-type","application/json; charset=utf-8");xhr.onreadystatechange=function(){var resp;if(xhr.readyState==4){if(xhr.status==200){resp=JSON.parse(xhr.responseText);plant.syncState="Success";plant.plant.user_id=resp.user_id;plant.plant.id=resp.id;plant.plant.updated_at=resp.updated_at;var update_time=plant.plant.updated_at;if(lastUpdateTime==null&&typeof update_time!=="undefined"){lastUpdateTime=update_time}else{var lstTime=new Date(lastUpdateTime);var uptTime=new Date(update_time);if(lstTime>uptTime){lastUpdateTime=update_time}}plant.failedStatus="200";if(typeof plant.browserTreeID==="undefined"||plant.browserTreeID==null){plant.browserTreeID=IDtemp;IDtemp++}if(grownTree.length>=100){grownTree.pop()}grownTree.push(plant);callback()}else{if(grownTree.length>=100){grownTree.pop()}if(typeof plant.plant.id==="undefined"||plant.plant.id==null){plant.syncState="Fail"}else if(plant.syncState=="WaitForSync"||plant.syncState=="EditFail"){plant.syncState="EditFail"}else{plant.syncState="Fail"}plant.failedStatus="422";if(typeof plant.browserTreeID==="undefined"||plant.browserTreeID==null){plant.browserTreeID=IDtemp;IDtemp++}grownTree.push(plant);if(xhr.status==403){chrome.storage.local.remove("user",function(){token=null});plant.failedStatus="403";callback()}else if(xhr.status==0){plant.failedStatus="0";callback()}else{callback()}}}};xhr.send(string)}}}})}function getStageToTreeNumber(stage){var number=stage-3;return number>=0?number:0}function getStage(time){if(TREE_TYPE[treeType].type==="BUSH"){return Math.floor(time/(lastTreeTime/3))+1}else{if(time<600){return 1}else if(time<1200){return 2}else if(time<1500){return 3}else if(time<3600){return 4}else if(time<5400){return 5}else if(time<7200){return 6}else{return 7}}}function getCurrTreeStage(){var passedTime=lastTreeTime-remainingTime;return getStage(passedTime)}function resetTree(){currentState=TREE_STATUS.READY;remainingTime=lastTreeTime}function getTimerText(){if(remainingTime<0){return""}var minute=Math.floor(remainingTime/60);var second=Math.floor(remainingTime%60);return(minute>=10?"":"0")+minute+":"+(second>=10?"":"0")+second}function setTimerText(){var timerText=getTimerText();if(currentState==TREE_STATUS.READY||currentState==TREE_STATUS.GROWING){hide("share-icons")}else{timerText="";unhide("share-icons")}executeToFrontPage(function(fp){fp.document.getElementById("timer").textContent=timerText})}function hide(id){executeToFrontPage(function(fp){addClass(fp.document.getElementById(id),"hidden")})}function unhide(id){executeToFrontPage(function(fp){removeClass(fp.document.getElementById(id),"hidden")})}function isTreeTypePurchased(treeType){if(TREE_TYPE[treeType].product_id==-1){return true}for(var idx in purchasedProducts){if(TREE_TYPE[treeType].product_id==purchasedProducts[idx].product_id){return true}}return false}function computeSuccessfulReward(totalSeconds){var totalMin=Math.floor(totalSeconds/60);var baseCoin=4;var fiveMinCoin=1;var thirtyMinCoin=5;if(totalSeconds<25*60){baseCoin=1}return baseCoin+Math.floor(totalMin/5)*fiveMinCoin+Math.max(Math.floor(totalMin/30)-1,0)*thirtyMinCoin}function onClickFinishConfirmedButton(doNotShowFinishMessageForGuest){isFinishMessageDismissed=true;executeToFrontPage(function(fp){var finishPopup=fp.document.getElementById("finish-popup");addClass(finishPopup,"finish-popup-shrink");var finishMask=fp.document.getElementById("finish-mask");removeClass(finishMask,"finish-masked")});window.setTimeout(function(){hide("finish-popup");hide("finish-mask")},300);if(doNotShowFinishMessageForGuest){doNotShowFinishMessageForGuest=true;chrome.storage.local.set({doNotShowFinishMessageForGuest:true},function(){})}}function updateUI(){var img;var seed_img;var topDesc;var stage=getCurrTreeStage();hide("timer-left-arrow");hide("timer-right-arrow");hide("treeball-left-arrow");hide("treeball-right-arrow");switch(currentState){case TREE_STATUS.READY:var readyStage=getStage(lastTreeTime);if(readyStage<3&&typeof TREE_TYPE[treeType].special_childhood!=="undefined"){if(TREE_TYPE[treeType].special_childhood.includes(parseInt(readyStage))){img="./images/trees/tree1/"+"tree_default_"+readyStage+".png"}else{img="./images/trees/tree"+(TREE_TYPE[treeType].id+1)+"/"+TREE_TYPE[treeType].prefix+"_"+readyStage+".png"}}else{img="./images/trees/tree"+(TREE_TYPE[treeType].id+1)+"/"+TREE_TYPE[treeType].prefix+"_"+readyStage+".png"}if(isTreeTypePurchased(treeType)){hide("locker");executeToFrontPage(function(fp){removeClass(fp.document.getElementById("tree"),"shadowed-tree")});topDesc=chrome.i18n.getMessage("main_top_description_ready")}else{unhide("locker");executeToFrontPage(function(fp){addClass(fp.document.getElementById("tree"),"shadowed-tree")});topDesc=chrome.i18n.getMessage("main_top_description_locked")}unhide("tree");unhide("seed");unhide("timer-left-arrow");unhide("timer-right-arrow");unhide("treeball-left-arrow");unhide("treeball-right-arrow");executeToFrontPage(function(fp){addClass(fp.document.getElementById("treeball"),"tree-cursor");addClass(fp.document.getElementById("seed"),"tree-cursor");addClass(fp.document.getElementById("tree"),"tree-cursor")});break;case TREE_STATUS.GROWING:if(stage<3){if(typeof TREE_TYPE[treeType].special_childhood=="undefined"){img="./images/trees/tree1/"+"tree_default_"+stage+".png"}else{if(TREE_TYPE[treeType].special_childhood.includes(parseInt(stage))){img="./images/trees/tree"+(TREE_TYPE[treeType].id+1)+"/"+TREE_TYPE[treeType].prefix+"_"+stage+".png"}else{img="./images/trees/tree1/"+"tree_default_"+stage+".png"}}}else{img="./images/trees/tree"+(TREE_TYPE[treeType].id+1)+"/"+TREE_TYPE[treeType].prefix+"_"+stage+".png"}hide("seed");unhide("tree");hide("plant-board");hide("plant-board-text");if(remainingTime%10===0){topDesRandInd=Math.floor(Math.random()*13)}topDesc=chrome.i18n.getMessage("main_message_growing_text_"+topDesRandInd);executeToFrontPage(function(fp){addClass(fp.document.getElementById("finish-popup"),"finish-popup-shrink");removeClass(fp.document.getElementById("treeball"),"tree-cursor");removeClass(fp.document.getElementById("seed"),"tree-cursor");removeClass(fp.document.getElementById("tree"),"tree-cursor")});break;case TREE_STATUS.GROWN:img="./images/trees/tree"+(TREE_TYPE[treeType].id+1)+"/"+TREE_TYPE[treeType].prefix+"_"+stage+".png";hide("seed");unhide("tree");hide("plant-board");hide("plant-board-text");topDesc=chrome.i18n.getMessage("main_top_description_grown");if(isFinishMessageDismissed){hide("finish-popup");hide("finish-mask")}else{unhide("finish-popup");unhide("finish-mask");unhide("do-not-show-finish-message-container");unhide("finish-message-for-guest-container");unhide("finish-message-for-user-container");executeToFrontPage(function(fp){addClass(fp.document.getElementById("edit-popup"),"edit-popup-shrink");removeClass(fp.document.getElementById("edit-mask"),"edit-masked")});window.setTimeout(function(){hide("edit-mask");hide("edit-popup")},300);executeToFrontPage(function(fp){addClass(fp.document.getElementById("finish-mask"),"finish-masked")});if(isLoggedIn){hide("do-not-show-finish-message-container");hide("finish-message-for-guest-container");executeToFrontPage(function(fp){fp.document.getElementById("coins-for-user").textContent=computeSuccessfulReward(lastTreeTime);addClass(fp.document.getElementById("finish-popup"),"finish-popup-for-user-width")})}else{hide("finish-message-for-user-container");executeToFrontPage(function(fp){removeClass(fp.document.getElementById("finish-popup"),"finish-popup-for-user-width")});if(doNotShowFinishMessageForGuest){hide("finish-popup");hide("finish-mask")}}}executeToFrontPage(function(fp){removeClass(fp.document.getElementById("treeball"),"tree-cursor");removeClass(fp.document.getElementById("seed"),"tree-cursor");removeClass(fp.document.getElementById("tree"),"tree-cursor")});break;case TREE_STATUS.FAILED:img="./images/trees/tree"+(TREE_TYPE[treeType].id+1)+"/"+TREE_TYPE[treeType].prefix+"_dead.png";hide("seed");unhide("tree");hide("plant-board");hide("plant-board-text");topDesc=chrome.i18n.getMessage("main_top_description_failed");executeToFrontPage(function(fp){removeClass(fp.document.getElementById("treeball"),"tree-cursor");removeClass(fp.document.getElementById("seed"),"tree-cursor");removeClass(fp.document.getElementById("tree"),"tree-cursor")});break}currTreeUrl=img;executeToFrontPage(function(fp){fp.document.getElementById("tree").style.backgroundImage="url('"+img+"')"});executeToFrontPage(function(fp){fp.document.getElementById("top-description").textContent=topDesc;removeClass(fp.document.getElementById("top-description"),"highlight-top-description")});if(currentState===TREE_STATUS.READY){unhide("setting-icon");unhide("top-icons");hide("edit-icon");hide("back-icon");chrome.tabs.query({active:true,lastFocusedWindow:true},function(tabs){if(tabs.length>0){var tab=tabs[0];if(typeof tab.url=="undefined"||!isWhitelistMode&&isBlacklisted(tab)||isWhitelistMode&&isWhitelisted(tab)){hide("add-to-blacklist-icon")}else{unhide("add-to-blacklist-icon")}}})}else{hide("add-to-blacklist-icon");hide("setting-icon");hide("top-icons");hide("edit-icon");if(currentState==TREE_STATUS.GROWN||currentState==TREE_STATUS.FAILED){unhide("back-icon")}if(currentState===TREE_STATUS.GROWING){unhide("edit-icon");chrome.tabs.query({},function(tabs){if(tabs.length>0){for(var idx in tabs){var tab=tabs[idx];if(typeof tab.url!="undefined"&&(isWhitelistMode&&!isWhitelisted(tab)||!isWhitelistMode&&isBlacklisted(tab))){chrome.tabs.sendMessage(tab.id,{type:"overlay",timerText:getTimerText(),treeUrl:img},{})}}}})}}setTimerText()}function killTree(tab){remainingTime=-1;currentState=TREE_STATUS.FAILED;uploadTree("grown",function(){});chrome.tabs.onUpdated.removeListener(checkForBlacklistAccess);chrome.tabs.onUpdated.removeListener(checkForWhitelistAccess);chrome.tabs.onReplaced.removeListener(onReplacedHandler);if(tab!==null){window.setTimeout(function(){chrome.tabs.query({url:tab.url},function(tabs){var title=tab.title;if(tabs!==null&&tabs.length>0){title=tabs[0].title}var message=title+" "+chrome.i18n.getMessage("notification_text_on_fail");chrome.notifications.create({type:"basic",requireInteraction:true,iconUrl:"icons/icon-512_padding.png",title:chrome.i18n.getMessage("notification_title_on_fail"),message:message})})},1e3)}clearTimeout(timer);updateUI()}function checkForBlacklistAccess(tabId,changeInfo,tab){if(!isWhitelistMode&&isBlacklisted(tab)){chrome.tabs.sendMessage(tab.id,{type:"overlay",timerText:getTimerText(),treeUrl:currTreeUrl},{})}}function checkForWhitelistAccess(tabId,changeInfo,tab){if(isWhitelistMode&&!isWhitelisted(tab)){chrome.tabs.sendMessage(tab.id,{type:"overlay",timerText:getTimerText(),treeUrl:currTreeUrl},{})}}function onReplacedHandler(addedTabId,removedTabId){chrome.tabs.get(addedTabId,function(tab){if(tab!==null){checkForBlacklistAccess(tab.id,null,tab);checkForWhitelistAccess(tab.id,null,tab)}})}function countDown(){var currSysTime=new Date;remainingTime=(targetSysTime.getTime()-currSysTime.getTime())/1e3;lastSysTime=currSysTime;if(currSysTime.getTime()-lastSysTime.getTime()<6e4&&currSysTime.getTime()-lastSysTime.getTime()>-6e4){}else{hasCheated=true;chrome.storage.local.get({user:null},function(items){})}remainingTime=Math.floor(remainingTime);if(remainingTime>0){chrome.storage.local.get({planting:null},function(items){var p=items.planting;p.plant.end_time=(new Date).toISOString();for(var i=0;i<getStageToTreeNumber(getCurrTreeStage())&&i<p.plant.trees.length;++i){p.plant.trees[i].is_dead=false;p.plant.trees[i].phase=i+4}chrome.storage.local.set({planting:p},function(){})});timer=window.setTimeout(countDown,1e3)}else if(currentState==TREE_STATUS.GROWING){chrome.tabs.query({},function(tabs){if(tabs.length>0){for(var idx in tabs){var tab=tabs[idx];if(isWhitelistMode&&!isWhitelisted(tab)||!isWhitelistMode&&isBlacklisted(tab)){chrome.tabs.sendMessage(tab.id,"unblock",{},function(){})}}}});chrome.tabs.onUpdated.removeListener(checkForBlacklistAccess);chrome.tabs.onUpdated.removeListener(checkForWhitelistAccess);chrome.tabs.onReplaced.removeListener(onReplacedHandler);chrome.storage.local.get({planting:null},function(items){var p=items.planting;p.plant.is_success=true;p.syncState="WaitForSync";for(var i=0;i<getStageToTreeNumber(getCurrTreeStage())&&i<p.plant.trees.length;++i){p.plant.trees[i].is_dead=false;p.plant.trees[i].phase=i+4}p.plant.end_time=(new Date).toISOString();var et=new Date(p.plant.start_time);et.setSeconds(et.getSeconds()+lastTreeTime);p.plant.end_time=et.toISOString();chrome.storage.local.set({planting:p},function(){uploadTree("grown",function(){})})});currentState=TREE_STATUS.GROWN;chrome.notifications.create({type:"basic",requireInteraction:true,iconUrl:"icons/icon-512_padding.png",title:chrome.i18n.getMessage("notification_title_on_success"),message:chrome.i18n.getMessage("notification_text_on_success")});chrome.storage.local.get({user:null},function(items){var user=items.user;if(user!==null){isLoggedIn=true}else{isLoggedIn=false}isFinishMessageDismissed=false;updateUI();executeToFrontPage(function(fp){removeClass(fp.document.getElementById("finish-popup"),"finish-popup-shrink")})})}updateUI()}function startTimer(isResume){if(currentState!=TREE_STATUS.READY){return}if(!isTreeTypePurchased(treeType)){return}chrome.storage.local.get({blackList:getDefaultBlacklist(),planting:null},function(items){blacklist=items.blackList;var planting=items.planting;hasCheated=false;lastSysTime=new Date;targetSysTime=new Date((new Date).getTime()+remainingTime*1e3+200);if(isResume){if(planting!==null&&typeof planting.plant!=="undefined"){var plant=planting.plant;targetSysTime=new Date(Date.parse(plant.start_time)+remainingTime*1e3+200)}else{return}}currentState=TREE_STATUS.GROWING;if(!isResume){savePlanting()}updateUI();chrome.tabs.onUpdated.addListener(checkForBlacklistAccess);chrome.tabs.onUpdated.addListener(checkForWhitelistAccess);chrome.tabs.onReplaced.addListener(onReplacedHandler);timer=window.setTimeout(countDown,1e3);chrome.tabs.query({},function(tabs){if(tabs.length>0){for(var idx in tabs){var tab=tabs[idx];if(isWhitelistMode&&!isWhitelisted(tab)||!isWhitelistMode&&isBlacklisted(tab)){chrome.tabs.sendMessage(tab.id,{type:"overlay",timerText:getTimerText(),treeUrl:currTreeUrl},{})}}}})});chrome.storage.local.get({user:null},function(items){})}function adjustTreeType(delta){if(currentState!=TREE_STATUS.READY){return}while(true){if(delta<0){treeType+=1;if(treeType>=TREE_TYPE.length-1){treeType=0}}else if(delta>0){treeType-=1;if(treeType<0){treeType=TREE_TYPE.length-2}}else{break}if(HIDDEN_TREE_TYPES.includes(TREE_TYPE[treeType].id)&&!isTreeTypePurchased(treeType)){continue}if(lastTreeTime<1500&&TREE_TYPE[treeType].type==="BUSH"){chrome.storage.local.set({lastBushType:treeType},function(){});break}else if(lastTreeTime>=1500&&TREE_TYPE[treeType].type==="TREE"){chrome.storage.local.set({lastTreeType:treeType},function(){});break}}chrome.storage.local.set({treeType:treeType},function(){});resetTree();updateUI()}function adjustPlantTime(delta){if(currentState!=TREE_STATUS.READY){return}chrome.storage.local.get({lastTreeType:0,lastBushType:6},function(items){if(delta<0){lastTreeTime+=300;if(lastTreeTime>7200){lastTreeTime=7200}}else if(delta>0){lastTreeTime-=300;if(lastTreeTime<600){lastTreeTime=600}}else{}var iterated_count=0;if(lastTreeTime<1500&&TREE_TYPE[treeType].type!=="BUSH"){while(treeType!=items.lastBushType&&iterated_count<TREE_TYPE.length){adjustTreeType(1);++iterated_count}}else if(lastTreeTime>=1500&&TREE_TYPE[treeType].type!=="TREE"){while(treeType!=items.lastTreeType&&iterated_count<TREE_TYPE.length){adjustTreeType(1);++iterated_count}}chrome.storage.local.set({lastTreeTime:lastTreeTime},function(){});resetTree();updateUI()})}function onMouseOnTreeball(action){return;if(currentState!=TREE_STATUS.READY||!isTreeTypePurchased(treeType)){return}if(action=="enter"){hide("tree");unhide("plant-board");unhide("plant-board-text")}else{unhide("tree");hide("plant-board");hide("plant-board-text")}}function updatePurchasedProducts(callback){chrome.storage.local.get({user:null,purchasedProducts:[]},function(items){var user=items.user;if(user===null){purchasedProducts=[];chrome.storage.local.set({purchasedProducts:[]},function(){});updateUI();return}else{purchasedProducts=items.purchasedProducts}var xhr=new XMLHttpRequest;var string="https://c88fef96.forestapp.cc/api/v1/purchases?authenticate_token="+user.remember_token;xhr.open("GET",string,true);xhr.setRequestHeader("Content-type","application/json; charset=utf-8");xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status==200){var resp=JSON.parse(xhr.responseText);purchasedProducts=resp;chrome.storage.local.set({purchasedProducts:purchasedProducts},function(){})}else if(xhr.status==403){purchasedProducts=[];chrome.storage.local.set({purchasedProducts:[]},function(){})}callback();updateUI()}};xhr.send()})}function isBlacklisted(tab){if(typeof tab.url=="undefined"){return false}for(var idx in blacklist){if(tab.url.indexOf(blacklist[idx])>=0){return true}}return false}function isWhitelisted(tab){if(typeof tab.url=="undefined"){return true}if(tab.url.startsWith("chrome://newtab")){return true}for(var idx in whitelist){if(tab.url.indexOf(whitelist[idx])>=0){return true}}return false}function setWhitelistMode(isWLMode){isWhitelistMode=isWLMode}function getIsWhitelistMode(){return isWhitelistMode}function setBlacklist(blist){blacklist=blist}function setWhitelist(wlist){whitelist=wlist}function clickShareButton(id){var message=currentState===TREE_STATUS.GROWN?chrome.i18n.getMessage("main_share_on_success"):chrome.i18n.getMessage("main_share_on_failed");var url=currentState===TREE_STATUS.GROWN?"http://www.forestapp.cc/sharings/planting_success":"http://www.forestapp.cc/sharings/planting_failed";if(id==="backBtn"){resetTree();updateUI()}else if(id==="twitterBtn"){chrome.tabs.create({url:"https://twitter.com/intent/tweet?text="+message+"&url="+url},function(tab){})}else if(id==="fbBtn"){chrome.tabs.create({url:"https://www.facebook.com/sharer/sharer.php?u="+url},function(tab){})}else{}}function init(){chrome.storage.local.set({DefaultTAG:DefaultTAG},function(){});chrome.runtime.onInstalled.addListener(function(details){chrome.storage.local.get({IDtemp:1,grownTree:null},function(items){var grownTree=items.grownTree;var IDtemp=parseInt(items.IDtemp);if(grownTree!=null){for(var i in grownTree){if(typeof grownTree[i].browserTreeID=="undefined"||grownTree[i].browserTreeID==null){grownTree[i].syncState="Fail";grownTree[i].browserTreeID=IDtemp;IDtemp++}}chrome.storage.local.set({grownTree:grownTree,IDtemp:IDtemp},function(){uploadTree("sync",function(){})})}})});chrome.storage.local.get({user:null},function(items){var xhr=new XMLHttpRequest;xhr.open("DELETE","https://c88fef96.forestapp.cc/api/v1/sessions/signout",true);var user=items.user;var string=JSON.stringify(user);if(user==null){xhr.setRequestHeader("Content-type","application/json; charset=utf-8");xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status==200){}else{}}};xhr.send(string)}});chrome.tabs.query({},function(tabs){if(tabs.length>0){for(var idx in tabs){var tab=tabs[idx];console.log(tab.url);if(typeof tab.url=="undefined"||tab.url.startsWith("chrome://")||tab.url.startsWith("vivaldi://")){continue}try{chrome.tabs.executeScript(tab.id,{file:"/js/overlay.js"});chrome.tabs.insertCSS(tab.id,{file:"/stylesheets/overlay.css"})}catch(e){console.log(e)}}}});function dummy(){}chrome.runtime.onMessage.addListener(function(m,sender,dummy){if(m.giveUp===true){killTree(null);chrome.notifications.create({type:"basic",requireInteraction:true,iconUrl:"icons/icon-512_padding.png",title:chrome.i18n.getMessage("notification_title_on_giveup"),message:chrome.i18n.getMessage("notification_text_on_giveup")});chrome.tabs.query({},function(tabs){if(tabs.length>0){for(var idx in tabs){var tab=tabs[idx];if(!isWhitelistMode&&isBlacklisted(tab)||isWhitelistMode&&!isWhitelisted(tab)){chrome.tabs.sendMessage(tab.id,{type:"failed",timerText:getTimerText(),treeUrl:currTreeUrl},{})}}}})}});updatePurchasedProducts(function(){});chrome.storage.local.get({lastTreeTime:1500,lastTreeTagId:0,treeType:0,blackList:getDefaultBlacklist(),whiteList:getDefaultWhitelist(),whitelist:null,isWhitelistMode:false,doNotShowFinishMessageForGuest:false},function(items){lastTreeTime=items.lastTreeTime;lastTreeTagId=items.lastTreeTagId;treeType=items.treeType;resetTree();updateUI();blacklist=items.blackList;whitelist=items.whiteList;if(items.whitelist!=null){var old_whitelist=items.whitelist;chrome.storage.remove("whitelist",function(items){});whitelist.concat(old_whitelist);chrome.storage.local.set({whiteList:whitelist},function(items){})}isWhitelistMode=items.isWhitelistMode;doNotShowFinishMessageForGuest=items.doNotShowFinishMessageForGuest;startTimer(true)});return;chrome.storage.local.get({lastTreeTime:1500,lastTreeTagId:0},function(items){lastTreeTime=items.lastTreeTime;lastTreeTagId=items.lastTreeTagId;chrome.storage.local.get({planting:null},function(items){var p=items.planting;if(p!==null){remainingTime=-1;currentState=TREE_STATUS.FAILED;uploadTree("grown",function(){})}else{resetTree()}updateUI()})});chrome.storage.local.get({treeType:0},function(items){treeType=items.treeType;updateUI()});chrome.storage.local.get({blackList:getDefaultBlacklist()},function(items){blacklist=items.blackList});chrome.storage.local.get({doNotShowFinishMessageForGuest:false},function(items){doNotShowFinishMessageForGuest=items.doNotShowFinishMessageForGuest});chrome.tabs.query({},function(tabs){if(tabs.length>0){for(var idx in tabs){var tab=tabs[idx];try{return;chrome.tabs.executeScript(tab.id,{file:"/js/overlay.js"});chrome.tabs.insertCSS(tab.id,{file:"/stylesheets/overlay.css"})}catch(e){}}}});updatePurchasedProducts(function(){});function dummy(){}chrome.runtime.onMessage.addListener(function(m,sender,dummy){if(m.giveUp===true){killTree(null);chrome.notifications.create({type:"basic",requireInteraction:true,iconUrl:"icons/icon-512_padding.png",title:chrome.i18n.getMessage("notification_title_on_giveup"),message:chrome.i18n.getMessage("notification_text_on_giveup")});chrome.tabs.query({},function(tabs){if(tabs.length>0){for(var idx in tabs){var tab=tabs[idx];if(typeof tab.url!="undefined"&&(!isWhitelistMode&&isBlacklisted(tab)||isWhitelistMode&&!isWhitelisted(tab))){chrome.tabs.sendMessage(tab.id,{type:"failed",timerText:getTimerText(),treeUrl:currTreeUrl},{},function(){})}}}})}})}init();